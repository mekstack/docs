=================
Quick Start +Lore
=================

    Тут описан процесс ручного создания виртуалки, подключения к VPN и
    настройки форварда HTTPS на неё с нуля.

Если не понятно: :doc:`faq`

-------------------------------------------------------
Создание сервера в `mekstack.ru <https://mekstack.ru>`_
-------------------------------------------------------

Авторизация в облаке настроена через auth.hse.ru

В `mekstack.ru/auth/login <https://mekstack.ru/auth/login>`_ вибирай
**Authenticate using Mekstack Vault**

| Дальше тебя перекинет на `vault.mekstack.ru <https://vault.mekstack.ru>`_.
Там по дефолту логин по ``oidc/``: **HSE Identity Provider**, он тебе и нужен

| При входе автоматически создадутся проекты, в которых ты состоишь.
| Переключаться между ними можно через дропдаун-меню слева сверху.
| Если ты не состоишь ни в каких проектах то тебя не пустит в облако с ошибкой 401.

..
    .. note::

       Тыкание кнопок в гуях можно пропустить и сразу раздеплоить инфру терраформом.
       `Реальный темплейт
       <https://github.com/mmskv/openstack-project-template>`_.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Создание :ref:`overlay-network`
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Без сетей в наше время никуда, создай себе одну.

#. Project -> Networks -> Create Network

#. Дальше придумай любой CIDR для подсети. Лучше из приватных, но я тебе не указ.

#. Созданная подсеть сейчас болтается в воздухе.

   Чтобы из этой подсети можно было ходить в интернет нужно соединить её
   с нашей сетью, которая называется :ref:`public`, потому что на ней
   сетевики настроили SNAT. Соединяются сети при помощи роутеров (немного
   L3 лора).

   | Создай роутер в Project -> Network -> Routers
   | В ``External Network`` должна стоять **public** сеть.

   .. image:: images/l3-lore.png
      :width: 500


#. Теперь твою подсеть нужно подключить к новому роутеру.

| Network -> Routers -> Тык на свой Router -> Interfaces -> Add Interface -> Выбираешь свою подсеть.
Произошла коммутация.

~~~~~~~~~~~~~~~~~~
Настройка Секгрупп
~~~~~~~~~~~~~~~~~~

| Дальше нужно настроить фаервол, потому что по дефолту он запрещает весь входящий траффик.
| Фаервол в опенстаке называется :ref:`security-group`.

Включи ICMP (это ping) и SSH в **default** секгруппе.

#. Project -> Network -> Security Groups -> default -> Manage Rules

#. Add Rule -> All ICMP -> Add

#. Add Rule -> SSH -> Add

~~~~~~~~~~~~~~~
Запуск Инстанса
~~~~~~~~~~~~~~~

:ref:`instance` это твоя виртуалочка

#. Compute -> Instances -> Launch Instance

#. Выбери имадж (это как iso, но без ручной установки)

#. Выбери :ref:`flavor`

#. В Networks выбери свою новую сеть

#. Security Groups пусть остаются на **default**

#. В Key Pair добавь свой публичный SSH ключ

#. Всё, запускай инстанс

| Инстанс сейчас в твоей приватной сетке, чтобы до него достучаться нужно прицепить к инстансу :ref:`fip`.
Floating IP выделяются из 172.18.218.0/23, к этой сетке есть доступ из под впн.

#. Project -> Network -> Floating IPs -> Alocate IP To Project

#. Project -> Network -> Floating IPs -> Associate

--------------------------------------------------
`vpnaas.mekstack.ru <https://vpnaas.mekstack.ru>`_
--------------------------------------------------

Сгенерь приватный и публичный ключ, вставь в сайт публичный, а свой конфиг приватный и готово.

.. code::

    sudo wg-quick up ./wg0.conf
    sudo wg-quick down ./wg0.conf

На Arch Wiki `написано <https://wiki.archlinux.org/title/WireGuard>`_ про Wireguard поподробнее.

~~~~~~~~~~~
Проверь впн
~~~~~~~~~~~

.. code::

    ping 172.18.218.2

| Если работает, то ссшься в свой сервер и делай что хочешь.
| Если не работает, то пиши в цулип.

-------------------
Публикация сайтиков
-------------------

Тяжело
